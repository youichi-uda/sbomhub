"use client";

import { useEffect, useState } from "react";
import { useTranslations } from "next-intl";
import { Badge } from "@/components/ui/badge";
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from "@/components/ui/tooltip";
import { Flame, AlertTriangle, Calendar } from "lucide-react";
import { api, KEVCheckResult } from "@/lib/api";

interface KEVBadgeProps {
  cveId: string;
  inKev?: boolean;
  kevDueDate?: string;
  kevRansomwareUse?: boolean;
  showDetails?: boolean;
}

export function KEVBadge({
  cveId,
  inKev,
  kevDueDate,
  kevRansomwareUse,
  showDetails = false,
}: KEVBadgeProps) {
  const t = useTranslations("KEV");
  const [kevInfo, setKevInfo] = useState<KEVCheckResult | null>(null);
  const [loading, setLoading] = useState(false);

  // If KEV status is not provided, fetch it
  useEffect(() => {
    if (inKev === undefined && cveId) {
      setLoading(true);
      api.kev
        .checkCVE(cveId)
        .then((data) => setKevInfo(data))
        .catch(() => setKevInfo(null))
        .finally(() => setLoading(false));
    }
  }, [cveId, inKev]);

  const isInKev = inKev ?? kevInfo?.in_kev ?? false;
  const dueDate = kevDueDate ?? kevInfo?.due_date;
  const ransomwareUse = kevRansomwareUse ?? kevInfo?.known_ransomware_use;

  if (loading) {
    return null;
  }

  if (!isInKev) {
    return null;
  }

  const dueDateFormatted = dueDate
    ? new Date(dueDate).toLocaleDateString()
    : null;
  const isOverdue = dueDate ? new Date(dueDate) < new Date() : false;

  return (
    <TooltipProvider>
      <Tooltip>
        <TooltipTrigger asChild>
          <Badge
            variant="destructive"
            className="gap-1 cursor-help bg-red-600 hover:bg-red-700"
          >
            <Flame className="h-3 w-3" />
            {t("badge")}
            {ransomwareUse && (
              <AlertTriangle className="h-3 w-3 ml-1" />
            )}
          </Badge>
        </TooltipTrigger>
        <TooltipContent side="top" className="max-w-xs">
          <div className="space-y-1">
            <p className="font-semibold">{t("title")}</p>
            <p className="text-sm text-muted-foreground">
              {t("description")}
            </p>
            {dueDateFormatted && (
              <div className="flex items-center gap-1 text-sm">
                <Calendar className="h-3 w-3" />
                <span className={isOverdue ? "text-red-400" : ""}>
                  {t("dueDate")}: {dueDateFormatted}
                  {isOverdue && ` (${t("overdue")})`}
                </span>
              </div>
            )}
            {ransomwareUse && (
              <div className="flex items-center gap-1 text-sm text-orange-400">
                <AlertTriangle className="h-3 w-3" />
                {t("ransomwareWarning")}
              </div>
            )}
          </div>
        </TooltipContent>
      </Tooltip>
    </TooltipProvider>
  );
}

// Compact version for lists
export function KEVIndicator({
  inKev,
  ransomwareUse,
}: {
  inKev?: boolean;
  ransomwareUse?: boolean;
}) {
  const t = useTranslations("KEV");

  if (!inKev) {
    return null;
  }

  return (
    <TooltipProvider>
      <Tooltip>
        <TooltipTrigger asChild>
          <span className="inline-flex items-center text-red-500">
            <Flame className="h-4 w-4" />
            {ransomwareUse && (
              <AlertTriangle className="h-3 w-3 ml-0.5 text-orange-500" />
            )}
          </span>
        </TooltipTrigger>
        <TooltipContent>
          <p>{t("exploitedTooltip")}</p>
          {ransomwareUse && (
            <p className="text-orange-400">{t("ransomwareWarning")}</p>
          )}
        </TooltipContent>
      </Tooltip>
    </TooltipProvider>
  );
}
