package handler

import (
	"context"
	"log/slog"
	"net/http"

	"github.com/google/uuid"
	"github.com/labstack/echo/v4"
	"github.com/sbomhub/sbomhub/internal/service"
)

type VulnerabilityHandler struct {
	nvdService *service.NVDService
	jvnService *service.JVNService
}

func NewVulnerabilityHandler(ns *service.NVDService, js *service.JVNService) *VulnerabilityHandler {
	return &VulnerabilityHandler{
		nvdService: ns,
		jvnService: js,
	}
}

func (h *VulnerabilityHandler) Scan(c echo.Context) error {
	projectID, err := uuid.Parse(c.Param("id"))
	if err != nil {
		return c.JSON(http.StatusBadRequest, map[string]string{"error": "invalid project id"})
	}

	sbomID, err := uuid.Parse(c.QueryParam("sbom_id"))
	if err != nil {
		return c.JSON(http.StatusBadRequest, map[string]string{"error": "sbom_id required"})
	}

	// Get scan sources from query param (default: both)
	sources := c.QueryParam("sources")
	if sources == "" {
		sources = "nvd,jvn"
	}

	go func() {
		ctx := context.Background()

		// Scan with NVD
		if sources == "nvd" || sources == "nvd,jvn" || sources == "jvn,nvd" {
			if err := h.nvdService.ScanComponents(ctx, sbomID); err != nil {
				slog.Error("NVD scan failed", "sbom_id", sbomID, "error", err)
			} else {
				slog.Info("NVD scan completed", "sbom_id", sbomID)
			}
		}

		// Scan with JVN
		if (sources == "jvn" || sources == "nvd,jvn" || sources == "jvn,nvd") && h.jvnService != nil {
			if err := h.jvnService.ScanComponents(ctx, sbomID); err != nil {
				slog.Error("JVN scan failed", "sbom_id", sbomID, "error", err)
			} else {
				slog.Info("JVN scan completed", "sbom_id", sbomID)
			}
		}
	}()

	return c.JSON(http.StatusAccepted, map[string]interface{}{
		"message":    "Vulnerability scan started",
		"project_id": projectID,
		"sbom_id":    sbomID,
		"sources":    sources,
	})
}
