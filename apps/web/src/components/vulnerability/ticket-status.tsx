"use client";

import { useState, useEffect } from "react";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from "@/components/ui/tooltip";
import { api, VulnerabilityTicketWithDetails } from "@/lib/api";
import { Ticket, ExternalLink, RefreshCw } from "lucide-react";

interface TicketStatusProps {
  vulnerabilityId: string;
  showDetails?: boolean;
}

function getStatusBadgeVariant(status: string): "default" | "secondary" | "outline" | "destructive" {
  switch (status) {
    case "open":
      return "default";
    case "in_progress":
      return "secondary";
    case "resolved":
    case "closed":
      return "outline";
    default:
      return "secondary";
  }
}

function getStatusLabel(status: string): string {
  switch (status) {
    case "open":
      return "オープン";
    case "in_progress":
      return "対応中";
    case "resolved":
      return "解決済み";
    case "closed":
      return "クローズ";
    default:
      return status;
  }
}

export function TicketStatus({ vulnerabilityId, showDetails = false }: TicketStatusProps) {
  const [tickets, setTickets] = useState<VulnerabilityTicketWithDetails[]>([]);
  const [loading, setLoading] = useState(true);
  const [syncing, setSyncing] = useState<string | null>(null);

  useEffect(() => {
    loadTickets();
  }, [vulnerabilityId]);

  const loadTickets = async () => {
    try {
      const data = await api.tickets.getByVulnerability(vulnerabilityId);
      setTickets(data.tickets || []);
    } catch (error) {
      console.error("Failed to load tickets:", error);
    } finally {
      setLoading(false);
    }
  };

  const handleSync = async (ticketId: string) => {
    setSyncing(ticketId);
    try {
      await api.tickets.sync(ticketId);
      await loadTickets();
    } catch (error) {
      console.error("Failed to sync ticket:", error);
    } finally {
      setSyncing(null);
    }
  };

  if (loading) {
    return null;
  }

  if (tickets.length === 0) {
    return null;
  }

  if (!showDetails) {
    // Compact view - just show badge
    const ticket = tickets[0];
    return (
      <TooltipProvider>
        <Tooltip>
          <TooltipTrigger asChild>
            <Badge variant={getStatusBadgeVariant(ticket.local_status)} className="gap-1 cursor-pointer">
              <Ticket className="h-3 w-3" />
              {ticket.external_ticket_key || "チケット"}
            </Badge>
          </TooltipTrigger>
          <TooltipContent>
            <div className="text-sm">
              <p className="font-medium">{ticket.tracker_name}</p>
              <p className="text-muted-foreground">
                ステータス: {getStatusLabel(ticket.local_status)}
                {ticket.external_status && ` (${ticket.external_status})`}
              </p>
              {ticket.assignee && (
                <p className="text-muted-foreground">担当: {ticket.assignee}</p>
              )}
            </div>
          </TooltipContent>
        </Tooltip>
      </TooltipProvider>
    );
  }

  // Detailed view
  return (
    <div className="space-y-2">
      {tickets.map((ticket) => (
        <div
          key={ticket.id}
          className="flex items-center justify-between p-3 rounded-lg border bg-muted/50"
        >
          <div className="flex items-center gap-3">
            <div className="p-1.5 rounded bg-background">
              <Ticket className="h-4 w-4" />
            </div>
            <div>
              <div className="flex items-center gap-2">
                <a
                  href={ticket.external_ticket_url}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="font-medium hover:underline flex items-center gap-1"
                >
                  {ticket.external_ticket_key || ticket.external_ticket_id}
                  <ExternalLink className="h-3 w-3" />
                </a>
                <Badge variant={getStatusBadgeVariant(ticket.local_status)}>
                  {getStatusLabel(ticket.local_status)}
                </Badge>
              </div>
              <div className="text-xs text-muted-foreground flex items-center gap-2 mt-0.5">
                <span>{ticket.tracker_name}</span>
                {ticket.assignee && (
                  <>
                    <span>•</span>
                    <span>担当: {ticket.assignee}</span>
                  </>
                )}
                {ticket.last_synced_at && (
                  <>
                    <span>•</span>
                    <span>
                      同期: {new Date(ticket.last_synced_at).toLocaleString("ja-JP")}
                    </span>
                  </>
                )}
              </div>
            </div>
          </div>

          <Button
            variant="ghost"
            size="icon"
            onClick={() => handleSync(ticket.id)}
            disabled={syncing === ticket.id}
          >
            <RefreshCw
              className={`h-4 w-4 ${syncing === ticket.id ? "animate-spin" : ""}`}
            />
          </Button>
        </div>
      ))}
    </div>
  );
}

// Simple badge for use in tables
export function TicketBadge({ vulnerabilityId }: { vulnerabilityId: string }) {
  const [ticket, setTicket] = useState<VulnerabilityTicketWithDetails | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    loadTicket();
  }, [vulnerabilityId]);

  const loadTicket = async () => {
    try {
      const data = await api.tickets.getByVulnerability(vulnerabilityId);
      if (data.tickets && data.tickets.length > 0) {
        setTicket(data.tickets[0]);
      }
    } catch (error) {
      // Silently fail
    } finally {
      setLoading(false);
    }
  };

  if (loading || !ticket) {
    return null;
  }

  return (
    <a
      href={ticket.external_ticket_url}
      target="_blank"
      rel="noopener noreferrer"
      className="inline-flex"
    >
      <Badge variant={getStatusBadgeVariant(ticket.local_status)} className="gap-1">
        <Ticket className="h-3 w-3" />
        {ticket.external_ticket_key}
      </Badge>
    </a>
  );
}
