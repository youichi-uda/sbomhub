"use client";

import { useState, useEffect } from "react";
import { Button } from "@/components/ui/button";
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from "@/components/ui/dialog";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { Badge } from "@/components/ui/badge";
import { api, IssueTrackerConnection, Vulnerability } from "@/lib/api";
import { Ticket, ExternalLink, Loader2 } from "lucide-react";

interface CreateTicketButtonProps {
  vulnerabilityId: string;
  projectId: string;
  vulnerability?: Vulnerability;
  variant?: "default" | "outline" | "ghost" | "secondary";
  size?: "default" | "sm" | "lg" | "icon";
}

export function CreateTicketButton({
  vulnerabilityId,
  projectId,
  vulnerability,
  variant = "outline",
  size = "sm",
}: CreateTicketButtonProps) {
  const [open, setOpen] = useState(false);
  const [connections, setConnections] = useState<IssueTrackerConnection[]>([]);
  const [loading, setLoading] = useState(false);
  const [creating, setCreating] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [success, setSuccess] = useState<{ url: string; key?: string } | null>(null);

  // Form state
  const [selectedConnection, setSelectedConnection] = useState<string>("");
  const [projectKey, setProjectKey] = useState("");
  const [issueType, setIssueType] = useState("");
  const [priority, setPriority] = useState("");
  const [summary, setSummary] = useState("");
  const [description, setDescription] = useState("");

  useEffect(() => {
    if (open) {
      loadConnections();
      // Set default summary
      if (vulnerability) {
        setSummary(`[${vulnerability.severity}] ${vulnerability.cve_id}`);
        setDescription(
          `脆弱性の対応が必要です。\n\nCVE ID: ${vulnerability.cve_id}\n重大度: ${vulnerability.severity}\nCVSSスコア: ${vulnerability.cvss_score}\n\n${vulnerability.description || ""}`
        );
      }
    }
  }, [open, vulnerability]);

  const loadConnections = async () => {
    setLoading(true);
    try {
      const data = await api.integrations.list();
      const activeConnections = (data.connections || []).filter((c) => c.is_active);
      setConnections(activeConnections);

      // Auto-select if only one connection
      if (activeConnections.length === 1) {
        setSelectedConnection(activeConnections[0].id);
        setProjectKey(activeConnections[0].default_project_key || "");
        setIssueType(activeConnections[0].default_issue_type || "");
      }
    } catch (error) {
      console.error("Failed to load connections:", error);
    } finally {
      setLoading(false);
    }
  };

  const handleConnectionChange = (connectionId: string) => {
    setSelectedConnection(connectionId);
    const conn = connections.find((c) => c.id === connectionId);
    if (conn) {
      setProjectKey(conn.default_project_key || "");
      setIssueType(conn.default_issue_type || "");
    }
  };

  const handleCreate = async () => {
    if (!selectedConnection) return;

    setCreating(true);
    setError(null);

    try {
      const ticket = await api.tickets.create(vulnerabilityId, {
        project_id: projectId,
        connection_id: selectedConnection,
        project_key: projectKey || undefined,
        issue_type: issueType || undefined,
        priority: priority || undefined,
        summary: summary || undefined,
        description: description || undefined,
      });

      setSuccess({
        url: ticket.external_ticket_url,
        key: ticket.external_ticket_key,
      });
    } catch (err) {
      setError(err instanceof Error ? err.message : "チケットの作成に失敗しました");
    } finally {
      setCreating(false);
    }
  };

  const handleClose = () => {
    setOpen(false);
    setSelectedConnection("");
    setProjectKey("");
    setIssueType("");
    setPriority("");
    setSummary("");
    setDescription("");
    setError(null);
    setSuccess(null);
  };

  return (
    <Dialog open={open} onOpenChange={(o) => (o ? setOpen(true) : handleClose())}>
      <DialogTrigger asChild>
        <Button variant={variant} size={size}>
          <Ticket className="h-4 w-4 mr-2" />
          チケット作成
        </Button>
      </DialogTrigger>
      <DialogContent className="sm:max-w-[500px]">
        <DialogHeader>
          <DialogTitle>チケットを作成</DialogTitle>
          <DialogDescription>
            この脆弱性に対応するためのチケットを作成します
          </DialogDescription>
        </DialogHeader>

        {success ? (
          <div className="py-6 text-center space-y-4">
            <div className="inline-flex items-center justify-center w-12 h-12 rounded-full bg-green-100 text-green-600">
              <Ticket className="h-6 w-6" />
            </div>
            <div>
              <h4 className="font-medium">チケットを作成しました</h4>
              {success.key && (
                <p className="text-sm text-muted-foreground mt-1">{success.key}</p>
              )}
            </div>
            <Button asChild>
              <a href={success.url} target="_blank" rel="noopener noreferrer">
                <ExternalLink className="h-4 w-4 mr-2" />
                チケットを開く
              </a>
            </Button>
          </div>
        ) : loading ? (
          <div className="py-6 text-center">
            <Loader2 className="h-8 w-8 animate-spin mx-auto text-muted-foreground" />
          </div>
        ) : connections.length === 0 ? (
          <div className="py-6 text-center space-y-3">
            <p className="text-muted-foreground">連携が設定されていません</p>
            <Button variant="outline" asChild>
              <a href="/settings/integrations">連携を設定する</a>
            </Button>
          </div>
        ) : (
          <>
            <div className="space-y-4 py-4">
              <div className="space-y-2">
                <Label htmlFor="connection">連携先</Label>
                <Select value={selectedConnection} onValueChange={handleConnectionChange}>
                  <SelectTrigger>
                    <SelectValue placeholder="連携先を選択" />
                  </SelectTrigger>
                  <SelectContent>
                    {connections.map((conn) => (
                      <SelectItem key={conn.id} value={conn.id}>
                        <div className="flex items-center gap-2">
                          <Badge variant="outline">
                            {conn.tracker_type === "jira" ? "Jira" : "Backlog"}
                          </Badge>
                          {conn.name}
                        </div>
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label htmlFor="project_key">プロジェクト</Label>
                  <Input
                    id="project_key"
                    value={projectKey}
                    onChange={(e) => setProjectKey(e.target.value)}
                    placeholder="PROJ"
                  />
                </div>

                <div className="space-y-2">
                  <Label htmlFor="issue_type">課題タイプ</Label>
                  <Input
                    id="issue_type"
                    value={issueType}
                    onChange={(e) => setIssueType(e.target.value)}
                    placeholder="Bug"
                  />
                </div>
              </div>

              <div className="space-y-2">
                <Label htmlFor="priority">優先度</Label>
                <Select value={priority} onValueChange={setPriority}>
                  <SelectTrigger>
                    <SelectValue placeholder="優先度を選択（オプション）" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="Highest">最高</SelectItem>
                    <SelectItem value="High">高</SelectItem>
                    <SelectItem value="Medium">中</SelectItem>
                    <SelectItem value="Low">低</SelectItem>
                    <SelectItem value="Lowest">最低</SelectItem>
                  </SelectContent>
                </Select>
              </div>

              <div className="space-y-2">
                <Label htmlFor="summary">タイトル</Label>
                <Input
                  id="summary"
                  value={summary}
                  onChange={(e) => setSummary(e.target.value)}
                  placeholder="チケットのタイトル"
                />
              </div>

              <div className="space-y-2">
                <Label htmlFor="description">説明</Label>
                <Textarea
                  id="description"
                  value={description}
                  onChange={(e) => setDescription(e.target.value)}
                  placeholder="チケットの説明"
                  rows={4}
                />
              </div>

              {error && (
                <div className="text-sm text-destructive bg-destructive/10 p-3 rounded-md">
                  {error}
                </div>
              )}
            </div>

            <DialogFooter>
              <Button variant="outline" onClick={handleClose}>
                キャンセル
              </Button>
              <Button
                onClick={handleCreate}
                disabled={creating || !selectedConnection}
              >
                {creating ? (
                  <>
                    <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                    作成中...
                  </>
                ) : (
                  "チケットを作成"
                )}
              </Button>
            </DialogFooter>
          </>
        )}
      </DialogContent>
    </Dialog>
  );
}
